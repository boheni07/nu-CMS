<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nucms.cms.mapper.CmsWorkflowMapper">

    <!-- 워크플로우 요청 등록 -->
    <insert id="insertWorkflowRequest" parameterType="com.nucms.cms.model.CmsWorkflowRequestVO">
        INSERT INTO CMS_WORKFLOW_REQUEST (
            REQ_ID, TARGET_ID, TARGET_TYPE, REQ_USER_ID, REQ_DT,
            REQ_SJ, REQ_CN, STATUS, DATA_SNAPSHOT
        ) VALUES (
            #{reqId}, #{targetId}, #{targetType}, #{reqUserId}, NOW(),
            #{reqSj}, #{reqCn}, 'REQUESTED', #{dataSnapshot}
        )
    </insert>

    <!-- 워크플로우 상태 변경 (승인/반려/취소) -->
    <update id="updateWorkflowRequestStatus" parameterType="com.nucms.cms.model.CmsWorkflowRequestVO">
        UPDATE CMS_WORKFLOW_REQUEST
        SET STATUS = #{status}
          , PROCESS_USER_ID = #{processUserId}
          , PROCESS_DT = NOW()
        WHERE REQ_ID = #{reqId}
    </update>

    <!-- 워크플로우 요청 목록 조회 -->
    <select id="selectWorkflowRequestList" parameterType="com.nucms.cms.model.CmsWorkflowRequestVO" resultType="com.nucms.cms.model.CmsWorkflowRequestVO">
        SELECT
            A.REQ_ID, A.TARGET_ID, A.TARGET_TYPE, A.REQ_USER_ID, A.REQ_DT,
            A.REQ_SJ, A.REQ_CN, A.STATUS, A.PROCESS_USER_ID, A.PROCESS_DT,
            B.MBER_NM AS reqUserNm,
            C.MBER_NM AS processUserNm
        FROM CMS_WORKFLOW_REQUEST A
        LEFT JOIN CMS_MEMBER B ON A.REQ_USER_ID = B.ESNTL_ID -- ID 컬럼 확인 필요 (MBER_ID vs ESNTL_ID)
        LEFT JOIN CMS_MEMBER C ON A.PROCESS_USER_ID = C.ESNTL_ID
        WHERE 1=1
        <if test="searchKeyword != null and searchKeyword != ''">
            AND (A.REQ_SJ LIKE CONCAT('%', #{searchKeyword}, '%') OR B.MBER_NM LIKE CONCAT('%', #{searchKeyword}, '%'))
        </if>
        <if test="status != null and status != ''">
            AND A.STATUS = #{status}
        </if>
        ORDER BY A.REQ_DT DESC
    </select>

    <!-- 워크플로우 요청 상세 조회 -->
    <select id="selectWorkflowRequest" parameterType="String" resultType="com.nucms.cms.model.CmsWorkflowRequestVO">
        SELECT
            A.REQ_ID, A.TARGET_ID, A.TARGET_TYPE, A.REQ_USER_ID, A.REQ_DT,
            A.REQ_SJ, A.REQ_CN, A.STATUS, A.PROCESS_USER_ID, A.PROCESS_DT,
            A.DATA_SNAPSHOT,
            B.MBER_NM AS reqUserNm,
            C.MBER_NM AS processUserNm
        FROM CMS_WORKFLOW_REQUEST A
        LEFT JOIN CMS_MEMBER B ON A.REQ_USER_ID = B.ESNTL_ID
        LEFT JOIN CMS_MEMBER C ON A.PROCESS_USER_ID = C.ESNTL_ID
        WHERE A.REQ_ID = #{reqId}
    </select>

    <!-- 워크플로우 이력 등록 -->
    <insert id="insertWorkflowHistory" parameterType="com.nucms.cms.model.CmsWorkflowHistoryVO">
        INSERT INTO CMS_WORKFLOW_HISTORY (
            REQ_ID, ACTION_CODE, ACTOR_ID, ACTION_DT, ACTION_MSG
        ) VALUES (
            #{reqId}, #{actionCode}, #{actorId}, NOW(), #{actionMsg}
        )
    </insert>

    <!-- 워크플로우 이력 목록 조회 -->
    <select id="selectWorkflowHistoryList" parameterType="String" resultType="com.nucms.cms.model.CmsWorkflowHistoryVO">
        SELECT
            A.HIST_ID, A.REQ_ID, A.ACTION_CODE, A.ACTOR_ID, A.ACTION_DT, A.ACTION_MSG,
            B.MBER_NM AS actorNm
        FROM CMS_WORKFLOW_HISTORY A
        LEFT JOIN CMS_MEMBER B ON A.ACTOR_ID = B.ESNTL_ID
        WHERE A.REQ_ID = #{reqId}
        ORDER BY A.ACTION_DT ASC
    </select>

</mapper>
